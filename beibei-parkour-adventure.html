<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒâ€â™€ï¸ è““è““çš„è·‘é…·å†’é™©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(45deg, #ff6b9d, #c44569, #f8b500, #ff6b9d);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            color: white;
            margin: 0;
            padding: 0;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            width: 100vw;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        .game-ui {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        }
        
        .game-ui h2 {
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 14px;
            color: #fff;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .game-world {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 200vw;
            height: 100vh;
            background: linear-gradient(to bottom, 
                rgba(255, 182, 193, 0.3) 0%, 
                rgba(255, 105, 180, 0.2) 50%, 
                rgba(255, 20, 147, 0.1) 100%);
            animation: scrollBackground 20s linear infinite;
            z-index: 1;
        }
        
        @keyframes scrollBackground {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }
        
        .ground {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 200vw;
            height: 100px;
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            border-top: 5px solid #fff;
            animation: scrollGround 8s linear infinite;
            z-index: 10;
        }
        
        @keyframes scrollGround {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }
        
        .player {
            position: absolute;
            left: 100px;
            bottom: 150px;
            width: 50px;
            height: 50px;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: all 0.1s ease;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        .player.jumping {
            animation: jump 0.6s ease-in-out;
        }
        
        @keyframes jump {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-150px) rotate(180deg); }
            100% { transform: translateY(0) rotate(360deg); }
        }
        
        .player.sliding {
            animation: slide 0.8s ease-in-out;
        }
        
        @keyframes slide {
            0% { transform: scaleY(1) scaleX(1); }
            50% { transform: scaleY(0.5) scaleX(1.5); }
            100% { transform: scaleY(1) scaleX(1); }
        }
        
        .obstacle {
            position: absolute;
            bottom: 100px;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            animation: moveObstacle 4s linear forwards;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        .obstacle.high {
            bottom: 180px;
        }
        
        @keyframes moveObstacle {
            from { right: -60px; }
            to { right: 100vw; }
        }
        
        .collectible {
            position: absolute;
            bottom: 150px;
            font-size: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            animation: moveCollectible 5s linear forwards, float 1s ease-in-out infinite alternate;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        .collectible.high {
            bottom: 250px;
        }
        
        @keyframes moveCollectible {
            from { right: -40px; }
            to { right: 100vw; }
        }
        
        @keyframes float {
            from { transform: translateY(0px); }
            to { transform: translateY(-10px); }
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 60;
            font-size: 20px;
            animation: particleFloat 1s ease-out forwards;
        }
        
        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.5);
            }
        }
        
        .score-popup {
            position: absolute;
            z-index: 70;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: scoreFloat 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes scoreFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.2);
            }
        }
        
        .power-meter {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 200px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border: 2px solid #fff;
            overflow: hidden;
            z-index: 100;
        }
        
        .power-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #ff1493, #ff69b4, #ffb6c1);
            border-radius: 8px;
            transition: height 0.2s ease;
        }
        
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #ff1493;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 200;
            display: none;
        }
        
        .restart-btn {
            background: linear-gradient(45deg, #ff69b4, #ff1493);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 20, 147, 0.4);
        }
        
        .achievements {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
            min-width: 200px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .achievement {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.6;
        }
        
        .achievement.unlocked {
            opacity: 1;
            animation: achievementUnlock 0.5s ease-out;
        }
        
        @keyframes achievementUnlock {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <script>
        console.log('ğŸš€ é¡µé¢å¼€å§‹åŠ è½½ - beibei-parkour-adventure.html');
        console.log('ğŸ“± çª—å£å°ºå¯¸:', window.innerWidth, 'x', window.innerHeight);
        console.log('ğŸ“„ æ–‡æ¡£å°±ç»ªçŠ¶æ€:', document.readyState);
    </script>
    
    <div class="game-container">
        <script>console.log('ğŸ® åˆ›å»ºgame-container');</script>
        
        <div class="game-ui">
            <script>console.log('ğŸ¯ åˆ›å»ºgame-ui');</script>
            <h2>ğŸƒâ€â™€ï¸ è““è““è·‘é…·</h2>
            <div class="stats">
                <div>ğŸ’– ç”Ÿå‘½: <span id="lives">3</span></div>
                <div>ğŸŒŸ åˆ†æ•°: <span id="score">0</span></div>
                <div>ğŸ’ é’»çŸ³: <span id="gems">0</span></div>
                <div>ğŸ“ è·ç¦»: <span id="distance">0</span>m</div>
                <div>âš¡ èƒ½é‡: <span id="energy">100</span>%</div>
            </div>
        </div>
        
        <div class="achievements">
            <script>console.log('ğŸ† åˆ›å»ºachievementsé¢æ¿');</script>
            <h3>ğŸ† æˆå°±</h3>
            <div class="achievement" id="firstRun">
                <span>ğŸŒŸ</span>
                <span>åˆæ¬¡å¥”è·‘</span>
            </div>
            <div class="achievement" id="collector">
                <span>ğŸ’</span>
                <span>é’»çŸ³æ”¶è—å®¶</span>
            </div>
            <div class="achievement" id="jumper">
                <span>ğŸ¦˜</span>
                <span>è·³è·ƒå¤§å¸ˆ</span>
            </div>
            <div class="achievement" id="survivor">
                <span>ğŸ’ª</span>
                <span>ç”Ÿå­˜ä¸“å®¶</span>
            </div>
            <div class="achievement" id="speedster">
                <span>âš¡</span>
                <span>é€Ÿåº¦ä¹‹ç‹</span>
            </div>
        </div>
        
        <div class="power-meter">
            <script>console.log('âš¡ åˆ›å»ºpower-meter');</script>
            <div class="power-fill" id="powerFill"></div>
        </div>
        
        <div class="controls">
            <script>console.log('ğŸ® åˆ›å»ºcontrolsé¢æ¿');</script>
            <div id="startControls">
                <button class="restart-btn" onclick="startGame()" style="margin-bottom: 10px;">ğŸ® å¼€å§‹æ¸¸æˆ</button>
            </div>
            <div id="gameControls" style="display: none;">
                <div>ğŸ® æ§åˆ¶æ–¹æ³•:</div>
                <div>ç©ºæ ¼é”®/ç‚¹å‡» = è·³è·ƒ | ä¸‹ç®­å¤´/å‘ä¸‹æ»‘ = æ»‘é“²</div>
                <div>æ”¶é›†ğŸ’é’»çŸ³ï¼Œé¿å¼€ğŸš§éšœç¢ç‰©ï¼</div>
            </div>
        </div>
        
        <div class="game-world">
            <script>console.log('ğŸŒ åˆ›å»ºgame-world');</script>
            <div class="background"></div>
            <div class="ground"></div>
            <div class="player" id="player">ğŸƒâ€â™€ï¸</div>
            <script>console.log('ğŸ‘¤ åˆ›å»ºplayerå…ƒç´ ');</script>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>ğŸ® æ¸¸æˆç»“æŸ</h2>
            <div id="finalStats"></div>
            <button class="restart-btn" onclick="restartGame()">ğŸ”„ é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script>
        console.log('ğŸ® å¼€å§‹æ‰§è¡Œä¸»JavaScriptä»£ç ');
        
        // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
        function checkElements() {
            const elements = [
                'player', 'lives', 'score', 'gems', 'distance', 'energy',
                'powerFill', 'startControls', 'gameControls'
            ];
            
            console.log('ğŸ” æ£€æŸ¥é¡µé¢å…ƒç´ :');
            console.log('ğŸ–¥ï¸ è§†å£å°ºå¯¸:', window.innerWidth, 'x', window.innerHeight);
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`  ${id}:`, element ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                if (element) {
                    const rect = element.getBoundingClientRect();
                    console.log(`    ä½ç½®: (${rect.left}, ${rect.top}) å°ºå¯¸: ${rect.width}x${rect.height}`);
                    console.log(`    å¯è§æ€§: display=${getComputedStyle(element).display}, visibility=${getComputedStyle(element).visibility}`);
                    
                    // ç‰¹æ®Šå¤„ç†playerå…ƒç´ 
                    if (id === 'player') {
                        const computedStyle = getComputedStyle(element);
                        console.log(`    Playerè¯¦ç»†ä¿¡æ¯:`);
                        console.log(`      position: ${computedStyle.position}`);
                        console.log(`      left: ${computedStyle.left}`);
                        console.log(`      bottom: ${computedStyle.bottom}`);
                        console.log(`      top: ${computedStyle.top}`);
                        console.log(`      çˆ¶å®¹å™¨é«˜åº¦: ${element.parentElement.offsetHeight}px`);
                        
                        // å°è¯•å¼ºåˆ¶è®¾ç½®ä½ç½®
                        if (rect.top > window.innerHeight - 200) {
                            console.log('ğŸ”§ Playerä½ç½®å¼‚å¸¸ï¼Œå°è¯•ä¿®å¤...');
                            element.style.position = 'fixed';
                            element.style.left = '100px';
                            element.style.bottom = '150px';
                            element.style.top = 'auto';
                        }
                    }
                }
            });
        }
        
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            isPlaying: true,
            lives: 3,
            score: 0,
            gems: 0,
            distance: 0,
            energy: 100,
            speed: 1,
            gameTime: 0,
            isJumping: false,
            isSliding: false,
            jumpCount: 0,
            gemsCollected: 0,
            obstaclesAvoided: 0
        };
        
        // æˆå°±ç³»ç»Ÿ
        const achievements = {
            firstRun: { unlocked: false, name: 'åˆæ¬¡å¥”è·‘', desc: 'å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡è·‘é…·å†’é™©' },
            collector: { unlocked: false, name: 'é’»çŸ³æ”¶è—å®¶', desc: 'æ”¶é›†10ä¸ªé’»çŸ³' },
            jumper: { unlocked: false, name: 'è·³è·ƒå¤§å¸ˆ', desc: 'è·³è·ƒ50æ¬¡' },
            survivor: { unlocked: false, name: 'ç”Ÿå­˜ä¸“å®¶', desc: 'è·‘è¿‡500ç±³' },
            speedster: { unlocked: false, name: 'é€Ÿåº¦ä¹‹ç‹', desc: 'è¾¾åˆ°æœ€é«˜é€Ÿåº¦' }
        };
        
        // éŸ³æ•ˆç³»ç»Ÿ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                switch(type) {
                    case 'jump':
                        oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.2);
                        break;
                    case 'collect':
                        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
                        break;
                    case 'hit':
                        oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                        break;
                    case 'slide':
                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                        oscillator.frequency.linearRampToValueAtTime(150, audioContext.currentTime + 0.5);
                        break;
                }
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('ğŸ”Š éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e);
            }
        }
        
        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            console.log('ğŸ® ç”¨æˆ·ç‚¹å‡»å¼€å§‹æ¸¸æˆ');
            
            // æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // éšè—å¼€å§‹æŒ‰é’®ï¼Œæ˜¾ç¤ºæ¸¸æˆæ§åˆ¶è¯´æ˜
            document.getElementById('startControls').style.display = 'none';
            document.getElementById('gameControls').style.display = 'block';
            
            // å¼€å§‹æ¸¸æˆ
            initGame();
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            console.log('ğŸ® åˆå§‹åŒ–è““è““è·‘é…·æ¸¸æˆ');
            updateUI();
            unlockAchievement('firstRun');
            startGameLoop();
        }
        
        // æ›´æ–°UI
        function updateUI() {
            console.log('ğŸ”„ æ›´æ–°UIï¼Œå½“å‰æ¸¸æˆçŠ¶æ€:', gameState);
            
            try {
                document.getElementById('lives').textContent = gameState.lives;
                document.getElementById('score').textContent = gameState.score;
                document.getElementById('gems').textContent = gameState.gems;
                document.getElementById('distance').textContent = Math.floor(gameState.distance);
                document.getElementById('energy').textContent = Math.floor(gameState.energy);
                document.getElementById('powerFill').style.height = gameState.energy + '%';
                
                console.log('âœ… UIæ›´æ–°æˆåŠŸ');
            } catch (error) {
                console.error('âŒ UIæ›´æ–°å¤±è´¥:', error);
            }
        }
        
        // ç©å®¶æ§åˆ¶
        const player = document.getElementById('player');
        
        function jump() {
            if (!gameState.isPlaying || gameState.isJumping || gameState.energy < 20) return;
            
            console.log('ğŸ¦˜ è““è““è·³è·ƒ!');
            gameState.isJumping = true;
            gameState.jumpCount++;
            gameState.energy -= 20;
            
            player.classList.add('jumping');
            playSound('jump');
            createParticles(player.offsetLeft + 25, player.offsetTop + 25, 'âœ¨');
            
            setTimeout(() => {
                gameState.isJumping = false;
                player.classList.remove('jumping');
            }, 600);
            
            // æ£€æŸ¥è·³è·ƒæˆå°±
            if (gameState.jumpCount >= 50) {
                unlockAchievement('jumper');
            }
        }
        
        function slide() {
            if (!gameState.isPlaying || gameState.isSliding || gameState.energy < 15) return;
            
            console.log('ğŸƒâ€â™€ï¸ è““è““æ»‘é“²!');
            gameState.isSliding = true;
            gameState.energy -= 15;
            
            player.classList.add('sliding');
            player.innerHTML = 'ğŸ¤¸â€â™€ï¸';
            playSound('slide');
            createParticles(player.offsetLeft + 25, player.offsetTop + 25, 'ğŸ’¨');
            
            setTimeout(() => {
                gameState.isSliding = false;
                player.classList.remove('sliding');
                player.innerHTML = 'ğŸƒâ€â™€ï¸';
            }, 800);
        }
        
        // äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                e.preventDefault();
                jump();
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                slide();
            }
        });
        
        // è§¦æ‘¸æ§åˆ¶
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        });
        
        document.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const diff = touchStartY - touchEndY;
            
            if (Math.abs(diff) > 30) {
                if (diff > 0) {
                    jump(); // å‘ä¸Šæ»‘åŠ¨è·³è·ƒ
                } else {
                    slide(); // å‘ä¸‹æ»‘åŠ¨æ»‘é“²
                }
            } else {
                jump(); // ç‚¹å‡»è·³è·ƒ
            }
        });
        
        // ç”Ÿæˆéšœç¢ç‰©
        function createObstacle() {
            if (!gameState.isPlaying) return;
            
            const obstacle = document.createElement('div');
            obstacle.className = 'obstacle';
            
            const types = ['ğŸš§', 'ğŸª¨', 'âš¡', 'ğŸŒµ', 'ğŸ”¥'];
            const isHigh = Math.random() > 0.7;
            
            if (isHigh) {
                obstacle.classList.add('high');
                obstacle.innerHTML = 'ğŸ¦…'; // é«˜ç©ºéšœç¢
            } else {
                obstacle.innerHTML = types[Math.floor(Math.random() * types.length)];
            }
            
            document.querySelector('.game-world').appendChild(obstacle);
            
            console.log('ğŸš§ ç”Ÿæˆéšœç¢ç‰©:', obstacle.innerHTML, isHigh ? '(é«˜ç©º)' : '(åœ°é¢)');
            
            // ç¢°æ’æ£€æµ‹
            const checkCollision = setInterval(() => {
                if (!document.body.contains(obstacle)) {
                    clearInterval(checkCollision);
                    return;
                }
                
                const obstacleRect = obstacle.getBoundingClientRect();
                const playerRect = player.getBoundingClientRect();
                
                if (obstacleRect.right >= playerRect.left && 
                    obstacleRect.left <= playerRect.right &&
                    obstacleRect.bottom >= playerRect.top && 
                    obstacleRect.top <= playerRect.bottom) {
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥é¿å…ç¢°æ’
                    const canAvoid = (isHigh && !gameState.isJumping) || 
                                   (!isHigh && (gameState.isJumping || gameState.isSliding));
                    
                    if (!canAvoid) {
                        console.log('ğŸ’¥ è““è““æ’åˆ°éšœç¢ç‰©!');
                        hitObstacle();
                        clearInterval(checkCollision);
                    } else {
                        console.log('âœ… æˆåŠŸé¿å¼€éšœç¢ç‰©!');
                        gameState.obstaclesAvoided++;
                        gameState.score += 20;
                        showScorePopup(playerRect.left, playerRect.top, '+20');
                    }
                }
            }, 16);
            
            // æ¸…ç†éšœç¢ç‰©
            setTimeout(() => {
                if (document.body.contains(obstacle)) {
                    obstacle.remove();
                    clearInterval(checkCollision);
                }
            }, 4000);
        }
        
        // ç”Ÿæˆæ”¶é›†å“
        function createCollectible() {
            if (!gameState.isPlaying) return;
            
            const collectible = document.createElement('div');
            collectible.className = 'collectible';
            
            const types = ['ğŸ’', 'ğŸŒŸ', 'ğŸ’–', 'âš¡', 'ğŸ“'];
            const isHigh = Math.random() > 0.5;
            
            if (isHigh) {
                collectible.classList.add('high');
            }
            
            collectible.innerHTML = types[Math.floor(Math.random() * types.length)];
            document.querySelector('.game-world').appendChild(collectible);
            
            console.log('ğŸ’ ç”Ÿæˆæ”¶é›†å“:', collectible.innerHTML, isHigh ? '(é«˜ç©º)' : '(ä½ç©º)');
            
            // æ”¶é›†æ£€æµ‹
            const checkCollection = setInterval(() => {
                if (!document.body.contains(collectible)) {
                    clearInterval(checkCollection);
                    return;
                }
                
                const collectibleRect = collectible.getBoundingClientRect();
                const playerRect = player.getBoundingClientRect();
                
                if (collectibleRect.right >= playerRect.left && 
                    collectibleRect.left <= playerRect.right &&
                    collectibleRect.bottom >= playerRect.top && 
                    collectibleRect.top <= playerRect.bottom) {
                    
                    console.log('ğŸŒŸ æ”¶é›†åˆ°:', collectible.innerHTML);
                    collectItem(collectible);
                    clearInterval(checkCollection);
                }
            }, 16);
            
            // æ¸…ç†æ”¶é›†å“
            setTimeout(() => {
                if (document.body.contains(collectible)) {
                    collectible.remove();
                    clearInterval(checkCollection);
                }
            }, 5000);
        }
        
        // æ”¶é›†ç‰©å“
        function collectItem(item) {
            const itemType = item.innerHTML;
            let points = 0;
            
            switch(itemType) {
                case 'ğŸ’':
                    gameState.gems++;
                    points = 50;
                    gameState.gemsCollected++;
                    break;
                case 'ğŸŒŸ':
                    points = 30;
                    break;
                case 'ğŸ’–':
                    if (gameState.lives < 5) gameState.lives++;
                    points = 25;
                    break;
                case 'âš¡':
                    gameState.energy = Math.min(100, gameState.energy + 30);
                    points = 20;
                    break;
                case 'ğŸ“':
                    points = 15;
                    break;
            }
            
            gameState.score += points;
            playSound('collect');
            createParticles(item.offsetLeft, item.offsetTop, itemType);
            showScorePopup(item.offsetLeft, item.offsetTop, '+' + points);
            item.remove();
            
            // æ£€æŸ¥é’»çŸ³æ”¶é›†æˆå°±
            if (gameState.gemsCollected >= 10) {
                unlockAchievement('collector');
            }
        }
        
        // æ’å‡»éšœç¢ç‰©
        function hitObstacle() {
            gameState.lives--;
            gameState.energy = Math.max(0, gameState.energy - 30);
            playSound('hit');
            
            // ç©å®¶é—ªçƒæ•ˆæœ
            player.style.animation = 'none';
            player.style.opacity = '0.5';
            setTimeout(() => {
                player.style.opacity = '1';
            }, 1000);
            
            createParticles(player.offsetLeft + 25, player.offsetTop + 25, 'ğŸ’¥');
            
            if (gameState.lives <= 0) {
                endGame();
            }
        }
        
        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticles(x, y, emoji) {
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.innerHTML = emoji;
                particle.style.left = (x + Math.random() * 40 - 20) + 'px';
                particle.style.top = (y + Math.random() * 40 - 20) + 'px';
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }
        
        // æ˜¾ç¤ºåˆ†æ•°å¼¹çª—
        function showScorePopup(x, y, text) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = text;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 1000);
        }
        
        // è§£é”æˆå°±
        function unlockAchievement(id) {
            if (achievements[id] && !achievements[id].unlocked) {
                achievements[id].unlocked = true;
                const element = document.getElementById(id);
                element.classList.add('unlocked');
                
                console.log('ğŸ† è§£é”æˆå°±:', achievements[id].name);
                showScorePopup(window.innerWidth/2, 100, 'ğŸ† ' + achievements[id].name);
                playSound('collect');
            }
        }
        
        // æ¸¸æˆä¸»å¾ªç¯
        function startGameLoop() {
            console.log('ğŸ”„ å¯åŠ¨æ¸¸æˆå¾ªç¯');
            
            const gameLoop = setInterval(() => {
                if (!gameState.isPlaying) {
                    clearInterval(gameLoop);
                    return;
                }
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                gameState.gameTime += 0.1;
                gameState.distance += gameState.speed;
                gameState.score += Math.floor(gameState.speed);
                
                // æ¢å¤èƒ½é‡
                if (gameState.energy < 100) {
                    gameState.energy += 0.5;
                }
                
                // å¢åŠ é€Ÿåº¦
                if (gameState.gameTime % 10 === 0) {
                    gameState.speed = Math.min(3, gameState.speed + 0.1);
                    if (gameState.speed >= 2.5) {
                        unlockAchievement('speedster');
                    }
                }
                
                // æ£€æŸ¥è·ç¦»æˆå°±
                if (gameState.distance >= 500) {
                    unlockAchievement('survivor');
                }
                
                updateUI();
            }, 100);
            
            // ç”Ÿæˆéšœç¢ç‰©
            const obstacleInterval = setInterval(() => {
                if (!gameState.isPlaying) {
                    clearInterval(obstacleInterval);
                    return;
                }
                createObstacle();
            }, 2000 - (gameState.speed * 200));
            
            // ç”Ÿæˆæ”¶é›†å“
            const collectibleInterval = setInterval(() => {
                if (!gameState.isPlaying) {
                    clearInterval(collectibleInterval);
                    return;
                }
                createCollectible();
            }, 1500);
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            console.log('ğŸ® æ¸¸æˆç»“æŸ!', {
                finalScore: gameState.score,
                distance: Math.floor(gameState.distance),
                gems: gameState.gems,
                jumps: gameState.jumpCount
            });
            
            gameState.isPlaying = false;
            
            const finalStats = document.getElementById('finalStats');
            finalStats.innerHTML = `
                <p>ğŸŒŸ æœ€ç»ˆåˆ†æ•°: ${gameState.score}</p>
                <p>ğŸ“ è·‘è¿‡è·ç¦»: ${Math.floor(gameState.distance)}ç±³</p>
                <p>ğŸ’ æ”¶é›†é’»çŸ³: ${gameState.gems}ä¸ª</p>
                <p>ğŸ¦˜ æ€»è·³è·ƒæ¬¡æ•°: ${gameState.jumpCount}æ¬¡</p>
                <p>ğŸš§ é¿å¼€éšœç¢: ${gameState.obstaclesAvoided}ä¸ª</p>
            `;
            
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            console.log('ğŸ”„ é‡æ–°å¼€å§‹æ¸¸æˆ');
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.isPlaying = true;
            gameState.lives = 3;
            gameState.score = 0;
            gameState.gems = 0;
            gameState.distance = 0;
            gameState.energy = 100;
            gameState.speed = 1;
            gameState.gameTime = 0;
            gameState.isJumping = false;
            gameState.isSliding = false;
            gameState.jumpCount = 0;
            gameState.gemsCollected = 0;
            gameState.obstaclesAvoided = 0;
            
            // æ¸…ç†UI
            document.getElementById('gameOver').style.display = 'none';
            player.style.opacity = '1';
            player.innerHTML = 'ğŸƒâ€â™€ï¸';
            player.className = 'player';
            
            // æ¸…ç†æ‰€æœ‰åŠ¨æ€å…ƒç´ 
            document.querySelectorAll('.obstacle, .collectible, .particle, .score-popup').forEach(el => el.remove());
            
            updateUI();
            startGameLoop();
        }
        
        // å¯åŠ¨æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ DOMå†…å®¹åŠ è½½å®Œæˆ!');
            console.log('ğŸ® è““è““çš„è·‘é…·å†’é™©é¡µé¢å°±ç»ª');
            
            // æ£€æŸ¥æ‰€æœ‰å…ƒç´ 
            checkElements();
            
            try {
                // ä¸è‡ªåŠ¨å¼€å§‹æ¸¸æˆï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»å¼€å§‹æŒ‰é’®
                updateUI();
                console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·å¼€å§‹æ¸¸æˆ');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„é¢å¤–æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('ğŸ¯ é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');
            
            // ç´§æ€¥ä¿®å¤ï¼šå¼ºåˆ¶è®¾ç½®æ‰€æœ‰å…ƒç´ ä½ç½®
            emergencyPositionFix();
            
            console.log('ğŸ” å†æ¬¡æ£€æŸ¥å…ƒç´ çŠ¶æ€...');
            setTimeout(() => {
                checkElements();
            }, 100);
        });
        
        // ç´§æ€¥ä½ç½®ä¿®å¤
        function emergencyPositionFix() {
            console.log('ğŸš¨ æ‰§è¡Œç´§æ€¥ä½ç½®ä¿®å¤...');
            
            // åŸºæœ¬UIä½ç½®ä¿®å¤
            const fixes = [
                { id: 'player', css: 'position:fixed !important; left:100px !important; bottom:200px !important; z-index:100 !important;' },
                { id: 'startControls', css: 'position:fixed !important; top:60% !important; left:50% !important; transform:translate(-50%,-50%) !important; z-index:1000 !important;' },
                { id: 'gameControls', css: 'position:fixed !important; bottom:40px !important; left:50% !important; transform:translateX(-50%) !important; z-index:1000 !important;' },
                { id: 'lives', css: 'position:fixed !important; top:20px !important; left:20px !important; z-index:1000 !important;' },
                { id: 'score', css: 'position:fixed !important; top:20px !important; right:20px !important; z-index:1000 !important;' },
                { id: 'gems', css: 'position:fixed !important; top:60px !important; left:20px !important; z-index:1000 !important;' },
                { id: 'distance', css: 'position:fixed !important; top:60px !important; right:20px !important; z-index:1000 !important;' },
                { id: 'energy', css: 'position:fixed !important; bottom:120px !important; left:20px !important; z-index:1000 !important;' }
            ];
            
            fixes.forEach(fix => {
                const element = document.getElementById(fix.id);
                if (element) {
                    element.style.cssText = fix.css;
                    console.log(`ğŸ”§ ä¿®å¤ ${fix.id} ä½ç½®`);
                }
            });
            
            // ä¿®å¤canvas
            const canvas = document.getElementById('gameCanvas');
            if (canvas) {
                canvas.style.cssText = 'position:fixed !important; top:0 !important; left:0 !important; width:100vw !important; height:100vh !important; z-index:1 !important;';
                console.log('ğŸ”§ ä¿®å¤ Canvas ä½ç½®');
            }
        }
    </script>
</body>
</html>
